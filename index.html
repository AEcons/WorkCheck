<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>AE ‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 700px; margin: auto; background: #f9f9f9; }
    .item, .project-block { background: white; border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; border-radius: 10px; }
    label { font-weight: bold; display: block; margin-top: 10px; }
    input[type="text"], select { width: 100%; padding: 8px; margin-top: 5px; }
    input[type="file"] { margin-top: 5px; }
    img { max-width: 100%; margin-top: 10px; border: 1px solid #ddd; border-radius: 5px; }
    button { margin: 10px 5px 0 0; padding: 10px 15px; border: none; background: #007bff; color: white; border-radius: 5px; cursor: pointer; }
    button:hover { background: #0056b3; }
  </style>
</head>
<body>

<h2>üèóÔ∏è ‡πÅ‡∏≠‡∏û AE ‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô</h2>

<div class="project-block">
  <label>‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£:</label>
  <input type="text" id="projectName" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ A, B, C" />

  <label>‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£ (Latitude, Longitude):</label>
  <input type="text" id="projectLatLng" placeholder="‡πÄ‡∏ä‡πà‡∏ô 13.7563, 100.5018" />
</div>

<div id="items"></div>
<button onclick="addItem()">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
<button onclick="saveAll()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
<button onclick="loadSaved()">üìÇ ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏î‡∏¥‡∏°</button>
<button onclick="exportToExcel()">üì§ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å Excel</button>

<hr>
<h3>üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ</h3>
<div id="saved"></div>

<script>
let itemIndex = 0;

function addItem(detail = '', beforeImg = '', afterImg = '') {
  const div = document.createElement('div');
  div.className = 'item';
  div.innerHTML = `
    <label>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô:</label>
    <input type="text" value="${detail}" name="desc${itemIndex}" />

    <label>‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥:</label>
    <input type="file" accept="image/*" onchange="previewImage(this, 'before${itemIndex}')" />
    <img id="before${itemIndex}" src="${beforeImg}" />

    <label>‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥:</label>
    <input type="file" accept="image/*" onchange="previewImage(this, 'after${itemIndex}')" />
    <img id="after${itemIndex}" src="${afterImg}" />
  `;
  document.getElementById('items').appendChild(div);
  itemIndex++;
}

function previewImage(input, imgId) {
  const reader = new FileReader();
  reader.onload = function (e) {
    document.getElementById(imgId).src = e.target.result;
  };
  reader.readAsDataURL(input.files[0]);
}

function saveAll() {
  const project = document.getElementById('projectName').value.trim();
  const latlng = document.getElementById('projectLatLng').value.trim();
  if (!project) return alert('‚ùó ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£');

  const data = [];
  const items = document.querySelectorAll('.item');
  items.forEach((item) => {
    const desc = item.querySelector('input[type=text]').value;
    const before = item.querySelectorAll('img')[0].src;
    const after = item.querySelectorAll('img')[1].src;
    data.push({ desc, before, after });
  });

  const allData = JSON.parse(localStorage.getItem('inspectionProjects') || '{}');
  allData[project] = {
    location: latlng,
    records: data
  };
  localStorage.setItem('inspectionProjects', JSON.stringify(allData));
  alert('‚úÖ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
}

function loadSaved() {
  const saved = JSON.parse(localStorage.getItem('inspectionProjects') || '{}');
  const container = document.getElementById('saved');
  container.innerHTML = '';
  Object.keys(saved).forEach((project) => {
    const block = document.createElement('div');
    block.className = 'project-block';
    block.innerHTML = `<h4>üìå ${project} (${saved[project].location})</h4>`;
    saved[project].records.forEach((item, i) => {
      block.innerHTML += `
        <div class="item">
          <p><b>‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î:</b> ${item.desc}</p>
          <p><b>‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥:</b><br><img src="${item.before}" /></p>
          <p><b>‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥:</b><br><img src="${item.after}" /></p>
        </div>
      `;
    });
    container.appendChild(block);
  });
}

function exportToExcel() {
  const saved = JSON.parse(localStorage.getItem('inspectionProjects') || '{}');
  if (Object.keys(saved).length === 0) {
    alert('‚ö†Ô∏è ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ');
    return;
  }

  const excelData = [];
  Object.keys(saved).forEach((project) => {
    const location = saved[project].location;
    saved[project].records.forEach((item, i) => {
      excelData.push({
        '‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£': project,
        '‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á': location,
        '‡∏•‡∏≥‡∏î‡∏±‡∏ö': i + 1,
        '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î': item.desc,
        '‡∏£‡∏π‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏ó‡∏≥ (Base64)': item.before,
        '‡∏£‡∏π‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏≥ (Base64)': item.after,
      });
    });
  });

  const worksheet = XLSX.utils.json_to_sheet(excelData);
  const workbook = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(workbook, worksheet, "‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î");

  XLSX.writeFile(workbook, "‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏á‡∏≤‡∏ô.xlsx");
}
</script>

</body>
</html>
